# Orca Reverse Proxy
This directory contains the source code for the Orca Reverse Proxy.
This reverse proxy allows applications to authenticate with a Kubernetes API using tokens generated by Auth0.  

## Authentication
Each request made to the proxy must contain an `Authorization : Bearer <token>` header.
The `token` must be a valid `access_token` generated by Auth0 after performing a successful OAuth2 exchange. 
The proxy will validate the token and use it to gather the token owner's email. 
The request will then be proxied to the Kubernetes API using the [`Impersonate-User` header](https://kubernetes.io/docs/reference/access-authn-authz/authentication/#user-impersonation) with the token owner's email. 

## Configuration

| Description                                                          | Flag           | Environment Variable | Default             |
|----------------------------------------------------------------------|----------------|----------------------|---------------------|
| The port to listen on                                                | --port         | OP_PORT              | 8080                |
| The Auth0 domain                                                     | --auth0-domain | OP_AUTH0_DOMAIN      | imshealth.auth0.com |
| Whether or not the proxy is running inside a K8s cluster             | --in-cluster   | OP_IN_CLUSTER        | false               |
| Path to kubeconfig file (only required if `--in-cluster` is false)   | --kubeconfig   | KUBECONFIG           | ~/.kube/config      |
| Duration to cache valid auth tokens                                  | --token-expiry | OP_TOKEN_EXPIRY      | 60m                 |

## Deployment
Please navigate to the [helm](helm/) directory for information on how to deployment this service using [Helm](https://helm.sh/). 
